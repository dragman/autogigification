<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Autogigification | Playlist Builder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Manrope:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0b0b;
      --card: rgba(255, 255, 255, 0.06);
      --muted: #9ca3af;
      --accent: #1db954;
      --accent-2: #0f7a32;
      --border: rgba(255, 255, 255, 0.08);
      --text: #e5e7eb;
      --shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Space Grotesk', 'Manrope', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px circle at 25% 20%, rgba(29, 185, 84, 0.12), transparent 45%),
        radial-gradient(700px circle at 80% 0%, rgba(15, 122, 50, 0.25), transparent 40%),
        linear-gradient(130deg, #0b0b0b 10%, #0f1113 35%, #080808 90%);
      padding: 32px;
    }

    header {
      max-width: 900px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .badge {
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(124, 246, 210, 0.15), rgba(164, 139, 255, 0.2));
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #c7d2fe;
    }

    h1 {
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.02em;
      font-size: clamp(28px, 4vw, 36px);
    }

    p.lede {
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 750px;
      line-height: 1.5;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
      color: var(--muted);
    }

    .field-title {
      color: var(--text);
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    input, textarea {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 15px;
      transition: border-color 0.2s ease, background 0.2s ease;
      outline: none;
    }

    input:focus, textarea:focus {
      border-color: rgba(124, 246, 210, 0.6);
      background: rgba(255, 255, 255, 0.06);
    }

    input:disabled, textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .grid-span-2 { width: 100%; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      color: #0b0b0b;
      background: linear-gradient(135deg, #1db954, #1aa34a);
      box-shadow: 0 12px 30px rgba(29, 185, 84, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      background: var(--border);
      color: var(--muted);
      box-shadow: none;
      transform: none;
    }

    .toggles {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    .toggles input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: #7cf6d2;
      cursor: pointer;
    }

    .status-line {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 14px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(124, 246, 210, 0.12);
    }

    pre {
      margin: 0;
      padding: 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: auto;
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 13px;
      line-height: 1.55;
      color: #c7d2fe;
    }

    .panel-title {
      margin: 0 0 8px;
      font-size: 14px;
      color: var(--muted);
    }

    .panels {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 960px) {
      .panels { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    }

    .response-link {
      margin-top: 12px;
    }

    .response-link a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1db954, #1aa34a);
      color: #0b0b0b;
      font-weight: 700;
      text-decoration: none;
      box-shadow: 0 12px 30px rgba(124, 246, 210, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .response-link a:hover { transform: translateY(-1px); }
    .response-link a:active { transform: translateY(0); }

    .setlist-grid {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    .setlist-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .setlist-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .setlist-header h4 {
      margin: 0;
      font-size: 16px;
      letter-spacing: -0.01em;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid var(--border);
    }

    .tag.fresh { background: rgba(29, 185, 84, 0.14); color: #1db954; }
    .tag.estimated { background: rgba(255, 193, 112, 0.12); color: #ffc170; }

    .song-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.06);
      font-size: 14px;
    }

    .song-row:last-child { border-bottom: none; }

    .song-row .missing {
      color: #ff9f9f;
      font-weight: 600;
    }

    .song-row a {
      color: #1db954;
      text-decoration: none;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
    }

    details.advanced {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.03);
    }

    details.advanced summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
      margin-bottom: 8px;
    }

    details.advanced[open] summary {
      margin-bottom: 12px;
    }

    .advanced-content {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 900px) {
      .advanced-content { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    }

    @media (max-width: 640px) {
      body { padding: 20px; }
      .controls { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <div class="badge">Setlist.fm -> Spotify</div>
    <div>
      <h1>Autogigification Control Room</h1>
      <p class="lede">
        Because nobody likes being surprised by a setlist.
      </p>
    </div>
  </header>

  <main>
    <section class="card">
      <form id="playlist-form">
        <label class="grid-span-2">
          <span class="field-title">Band names (comma or new line)</span>
          <textarea id="band_names" name="band_names" placeholder="Band A, Band B&#10;Artist C"></textarea>
        </label>

        <label>
          <span class="field-title">Playlist name <span class="hint">(set to create, leave empty to preview)</span></span>
          <input type="text" id="playlist_name" name="playlist_name" placeholder="Tour Warmup 2024" />
          <span class="hint" id="playlist_hint"></span>
        </label>

        <details class="advanced">
          <summary>Advanced options (endpoint, token, caching, limits)</summary>
          <div class="advanced-content">
            <label class="grid-span-2">
              <span class="field-title">Lambda endpoint URL</span>
              <input type="url" id="endpoint" name="endpoint" value="https://24n2uybzmrhy5gdubam2dvvjby0dtkfh.lambda-url.eu-north-1.on.aws/" required />
            </label>

            <label>
              <span class="field-title">Bearer token (only for playlist creation)</span>
              <input type="text" id="token" name="token" placeholder="my-secret-token" />
            </label>

            <div class="toggles">
              <input type="checkbox" id="no_cache" name="no_cache" checked />
              <label for="no_cache" style="margin: 0;">Skip caches (send <code>no_cache: true</code>)</label>
            </div>

            <div class="toggles">
              <input type="checkbox" id="force_smart_setlist" name="force_smart_setlist" />
              <label for="force_smart_setlist" style="margin: 0;">Force setlist estimation (even if fresh)</label>
            </div>

            <div class="toggles">
              <input type="checkbox" id="use_fuzzy_search" name="use_fuzzy_search" checked />
              <label for="use_fuzzy_search" style="margin: 0;">Fuzzy track name matching</label>
            </div>

            <label>
              <span class="field-title">Copy last setlist threshold (days)</span>
              <input type="number" id="copy_last_setlist_threshold" name="copy_last_setlist_threshold" min="1" value="15" />
            </label>

            <label>
              <span class="field-title">Max setlist length (songs)</span>
              <input type="number" id="max_setlist_length" name="max_setlist_length" min="1" value="12" />
            </label>

            <label>
              <span class="field-title">Rate limit (seconds, 0 for none)</span>
              <input type="number" id="rate_limit" name="rate_limit" min="0" step="0.1" value="1" />
            </label>

            <div class="toggles">
              <input type="checkbox" id="local_mode" name="local_mode" />
              <label for="local_mode" style="margin: 0;">Local Lambda mode (wrap request & use local invoke URL)</label>
            </div>
          </div>
        </details>

        <div class="controls grid-span-2">
          <button type="submit" id="submit-btn">Build Spotify Playlist</button>
          <div class="status-line" id="status-line">
            <span class="dot" id="status-dot"></span>
            <span id="status-text">Idle</span>
          </div>
        </div>
      </form>
    </section>

    <section class="card">
      <p class="panel-title">Results</p>
      <div id="setlist-summary" class="setlist-grid"></div>
      <div id="response-link" class="response-link"></div>
    </section>

    <details class="advanced">
      <summary>Debug details (payload + raw response)</summary>
      <div class="advanced-content">
        <div class="card">
          <p class="panel-title">Payload preview</p>
          <pre id="payload-preview">{}</pre>
        </div>
        <div class="card">
          <p class="panel-title">Lambda response</p>
          <pre id="response-preview">Waiting for a request...</pre>
        </div>
      </div>
    </details>
  </main>

  <script>
    const form = document.getElementById('playlist-form');
    const payloadPreview = document.getElementById('payload-preview');
    const responsePreview = document.getElementById('response-preview');
    const responseLink = document.getElementById('response-link');
    const setlistSummary = document.getElementById('setlist-summary');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    const submitButton = document.getElementById('submit-btn');

    const bandsInput = document.getElementById('band_names');
    const playlistInput = document.getElementById('playlist_name');
    const playlistHint = document.getElementById('playlist_hint');
    const copyThresholdInput = document.getElementById('copy_last_setlist_threshold');
    const maxLengthInput = document.getElementById('max_setlist_length');
    const noCacheInput = document.getElementById('no_cache');
    const forceSmartInput = document.getElementById('force_smart_setlist');
    const fuzzyInput = document.getElementById('use_fuzzy_search');
    const rateLimitInput = document.getElementById('rate_limit');
    const tokenInput = document.getElementById('token');
    const endpointInput = document.getElementById('endpoint');
    const fillExampleButton = document.getElementById('fill-example');
    const localModeInput = document.getElementById('local_mode');
    const TOKEN_STORAGE_KEY = 'ag_bearer_token';
    const LOCAL_INVOKE_URL = 'http://127.0.0.1:8787/2015-03-31/functions/function/invocations';
    let savedEndpointValue = endpointInput.value;

    const parseBands = (value) => value.split(/\r?\n|,/).map((item) => item.trim()).filter(Boolean);

    const buildPayload = () => {
      const playlistName = playlistInput.value.trim();
      return {
        band_names: parseBands(bandsInput.value),
        playlist_name: playlistName || null,
        copy_last_setlist_threshold: Number(copyThresholdInput.value) || 15,
        max_setlist_length: Number(maxLengthInput.value) || 12,
        no_cache: Boolean(noCacheInput.checked),
        rate_limit: Number(rateLimitInput.value) || 1.0,
        create_playlist: Boolean(playlistName),
        force_smart_setlist: Boolean(forceSmartInput.checked),
        use_fuzzy_search: Boolean(fuzzyInput.checked),
      };
    };

    const updatePreview = () => {
      payloadPreview.textContent = JSON.stringify(buildPayload(), null, 2);
    };

    const updateSubmitLabel = () => {
      const playlistName = playlistInput.value.trim();
      submitButton.textContent = playlistName
        ? 'Create Spotify Playlist'
        : 'Preview setlists + links';
    };

    const hasToken = () => Boolean(tokenInput.value.trim());
    const wantsPlaylistCreation = () => Boolean(playlistInput.value.trim());

    const updatePlaylistNameState = () => {
      const tokenPresent = hasToken();
      const creationEnabled = wantsPlaylistCreation();
      playlistInput.disabled = !tokenPresent;
      playlistInput.required = creationEnabled && tokenPresent;
      playlistHint.textContent = tokenPresent
        ? creationEnabled
          ? 'Playlist will be created'
          : 'Leave empty to preview only'
        : 'Add a bearer token to enable playlist creation';
    };

    const setStatus = (text, color = 'var(--accent)') => {
      statusText.textContent = text;
      statusDot.style.background = color;
      statusDot.style.boxShadow = `0 0 0 4px ${color === 'var(--accent)' ? 'rgba(124, 246, 210, 0.12)' : 'rgba(255, 124, 124, 0.12)'}`;
    };

    const updateResponseLink = (maybeUrl, created) => {
      if (created && maybeUrl) {
        responseLink.innerHTML = `<a href="${maybeUrl}" target="_blank" rel="noopener noreferrer">Open playlist ↗</a>`;
      } else if (!created) {
        responseLink.innerHTML = '<div class="chip-row"><span class="tag estimated">Preview mode</span><span>No playlist created (follow links below)</span></div>';
      } else {
        responseLink.textContent = '';
      }
    };

    const renderSetlistSummary = (inner) => {
      const setlists = inner?.setlists || [];
      if (!Array.isArray(setlists) || setlists.length === 0) {
        return '';
      }

      return `<div class="setlist-grid">
        ${setlists.map((setlist) => {
          const missing = setlist.missing_songs || [];
          const songs = setlist.songs || [];
          const tagClass = setlist.setlist_type === 'fresh' ? 'fresh' : 'estimated';
          const songList = songs.map((song) => {
            const link = song.spotify_url
              ? `<a href="${song.spotify_url}" target="_blank" rel="noopener noreferrer">Spotify ↗</a>`
              : '<span class="missing">Not found</span>';
            return `<div class="song-row">
              <span>${song.name}</span>
              ${link}
            </div>`;
          }).join('');
          const chips = [];
          if (setlist.setlist_date) chips.push(`Date ${setlist.setlist_date}`);
          if (setlist.last_setlist_age_days !== null && setlist.last_setlist_age_days !== undefined) {
            chips.push(`${setlist.last_setlist_age_days} days old`);
          }
          if (missing.length > 0) {
            chips.push(`<strong>${missing.length} missing</strong>`);
          }
          return `<div class="setlist-card">
            <div class="setlist-header">
              <h4>${setlist.band}</h4>
              <span class="tag ${tagClass}">${setlist.setlist_type}</span>
            </div>
            ${songList}
            <div class="chip-row">${chips.join(' · ')}</div>
          </div>`;
        }).join('')}
      </div>`;
    };

    const buildRequest = (endpoint, payload, authHeader) => {
      const autoDetectLocal = endpoint.includes('/2015-03-31/functions/function/invocations');
      const isLocalInvoke = localModeInput.checked || autoDetectLocal;

      if (isLocalInvoke) {
        // Local Lambda runtime expects the full event envelope.
        return {
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            headers: authHeader ? { authorization: authHeader } : {},
            body: JSON.stringify(payload),
            isBase64Encoded: false,
          }),
        };
      }

      // Deployed Lambda/function URL/API Gateway expects the raw payload and auth header directly.
      const headers = { 'Content-Type': 'application/json' };
      if (authHeader) {
        headers['Authorization'] = authHeader;
      }

      return { headers, body: JSON.stringify(payload) };
    };

    form.addEventListener('input', () => {
      updatePreview();
      updateSubmitLabel();
      updatePlaylistNameState();
    });
    localModeInput.addEventListener('change', () => {
      if (localModeInput.checked) {
        savedEndpointValue = endpointInput.value;
        endpointInput.value = LOCAL_INVOKE_URL;
        setStatus('Local mode enabled (endpoint overridden and request wrapped)');
      } else {
        endpointInput.value = savedEndpointValue || endpointInput.value;
        setStatus('Local mode off');
      }
    });
    const applyTokenFromQuery = () => {
      const url = new URL(window.location.href);
      const queryToken = url.searchParams.get('token') || url.searchParams.get('bearer');
      const storedToken = localStorage.getItem(TOKEN_STORAGE_KEY);

      if (queryToken) {
        tokenInput.value = queryToken;
        localStorage.setItem(TOKEN_STORAGE_KEY, queryToken);

        url.searchParams.delete('token');
        url.searchParams.delete('bearer');
        const cleanSearch = url.searchParams.toString();
        const newUrl = cleanSearch ? `${url.pathname}?${cleanSearch}${url.hash}` : `${url.pathname}${url.hash}`;
        history.replaceState(null, '', newUrl);
        setStatus('Token captured from link and hidden from URL');
      } else if (storedToken) {
        tokenInput.value = storedToken;
      }
      updatePlaylistNameState();
    };

    tokenInput.addEventListener('input', () => {
      const token = tokenInput.value.trim();
      if (token) {
        localStorage.setItem(TOKEN_STORAGE_KEY, token);
      }
      updatePlaylistNameState();
    });

    if (fillExampleButton) {
      fillExampleButton.addEventListener('click', () => {
        bandsInput.value = 'Band A\nBand B\nArtist C';
        playlistInput.value = 'Rehearsal Mix';
        copyThresholdInput.value = 10;
        maxLengthInput.value = 12;
        rateLimitInput.value = 0.5;
        noCacheInput.checked = true;
        updatePreview();
        updateSubmitLabel();
        setStatus('Example payload loaded');
      });
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = buildPayload();
      if (payload.band_names.length === 0) {
        setStatus('At least one band is required.', 'salmon');
        return;
      }

      const endpoint = endpointInput.value.trim();
      if (!endpoint) {
        setStatus('Endpoint URL is required.', 'salmon');
        return;
      }

      setStatus('Sending request...');
      responsePreview.textContent = 'Waiting for response...';
      setlistSummary.innerHTML = '<div class="chip-row"><span>Working...</span></div>';
      submitButton.disabled = true;
      const originalLabel = submitButton.textContent;
      submitButton.textContent = 'Working...';

      const token = tokenInput.value.trim();
      const wantsCreation = Boolean(payload.playlist_name);
      if (wantsCreation && !token) {
        setStatus('Add a bearer token to create the playlist, or clear the playlist name to preview.', '#ff7c7c');
        submitButton.disabled = false;
        submitButton.textContent = originalLabel;
        return;
      }
      const authHeader = token ? (token.startsWith('Bearer ') ? token : `Bearer ${token}`) : '';
      const { headers, body } = buildRequest(endpoint, payload, authHeader);

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers,
          body,
        });

        const text = await response.text();
        let parsedBody;
        try {
          parsedBody = text ? JSON.parse(text) : null;
        } catch (err) {
          parsedBody = text;
        }

        let innerBody = parsedBody;
        if (parsedBody && typeof parsedBody === 'object' && typeof parsedBody.body === 'string') {
          try {
            innerBody = JSON.parse(parsedBody.body);
          } catch (_) {
            innerBody = parsedBody.body;
          }
        }

        const output = {
          status: response.status,
          ok: response.ok,
          body: parsedBody,
          inner: innerBody,
        };

        responsePreview.textContent = JSON.stringify(output, null, 2);
        const linkUrl = innerBody?.playlist?.url || parsedBody?.playlist?.url;
        const created = Boolean(innerBody?.created_playlist ?? parsedBody?.created_playlist);
        updateResponseLink(linkUrl, created);
        const summary = renderSetlistSummary(innerBody || parsedBody);
        setlistSummary.innerHTML = summary || '<div class="chip-row"><span>No results yet.</span></div>';
        setStatus(response.ok ? 'Lambda responded successfully' : 'Lambda returned an error', response.ok ? 'var(--accent)' : '#ff7c7c');
      } catch (error) {
        responsePreview.textContent = `Request failed: ${error.message}`;
        updateResponseLink(null, false);
        setlistSummary.innerHTML = '';
        setStatus('Network error', '#ff7c7c');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalLabel;
      }
    });

    // Initialize preview on load.
    updatePlaylistNameState();
    updatePreview();
    applyTokenFromQuery();
    updateSubmitLabel();

    // Auto-enable local mode when served from localhost to streamline `make run`.
    const isLocalHost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
    if (isLocalHost && !localModeInput.checked) {
      localModeInput.checked = true;
      localModeInput.dispatchEvent(new Event('change'));
    }
  </script>
</body>
</html>
